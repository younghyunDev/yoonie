<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ½ï¸ ìœ¤ì´ ì˜¤ëŠ˜ ë­ ë¨¹ì§€? (ì™„ì„±ë³¸)</title>
  <style>
    /* CSS ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤. */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to bottom right, #fff9f0, #ffe0e0); color: #333; padding: 1rem; margin: 0; }
    .header-container { text-align: center; margin-bottom: 2rem; }
    h1 { font-size: 2.5rem; line-height: 1.2; margin: 0 0 1rem 0; }
    .tree { display: block; max-width: 800px; margin: 0 auto; padding: 1rem; background: #fff; border-radius: 1rem; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); position: relative; min-height: 150px; }
    .node { position: relative; padding-left: 1rem; margin-bottom: 1rem; transition: background-color 0.3s ease, opacity 0.5s ease; display: flex; justify-content: space-between; align-items: center; }
    .node-content { display: flex; align-items: center; gap: 0.5rem; }
    .parent-node > .node-content { cursor: pointer; }
    .toggle-icon { display: inline-block; width: 1em; transition: transform 0.2s ease-in-out; padding-right: 5px; }
    .parent-node.expanded > .node-content .toggle-icon { transform: rotate(90deg); }
    .branch { margin-left: 1.5rem; border-left: 2px dashed #ccc; padding-left: 1rem; display: none; }
    .branch.visible { display: block; }
    .choice-node { cursor: pointer; border-radius: 8px; }
    .choice-node:hover { background-color: #fdf5e6; }
    .selected { background-color: #e0f7fa; font-weight: bold; }
    .unselected { opacity: 0.4; pointer-events: none; }
    
    /* [ìˆ˜ì •] ì„ì‹œ ì œì™¸ ìŠ¤íƒ€ì¼ */
    .temp-removed { opacity: 0.5; }
    .temp-removed > .node-content .node-text { text-decoration: line-through; color: #aaa; }

    .button-container { text-align: center; margin: 1.5rem 0; }
    .action-button { margin: 0.25rem 0.5rem; padding: 0.75rem 1.5rem; font-size: 1rem; color: white; border: none; border-radius: 1rem; cursor: pointer; transition: all 0.3s ease; }
    .action-button.start { background-color: #ff9a9e; }
    .action-button.start:hover { background-color: #ff6a6a; transform: scale(1.05); }
    .action-button.reset { background-color: #a0aec0; }
    .action-button.reset:hover { background-color: #718096; transform: scale(1.05); }
    .action-button.search { background-color: #f7e600; color: #3d1e1f; font-weight: bold;}
    .action-button.search:hover { background-color: #e8d700; transform: scale(1.05); }
    .action-button.edit { background-color: #f6ad55; }
    .action-button.edit:hover { background-color: #ed8936; transform: scale(1.05); }
    .result { text-align: center; margin-top: 1.5rem; font-size: 1.5rem; font-weight: bold; color: #d6336c; min-height: 2rem; }
    .highlight { background-color: #fff3cd; border-radius: 4px; }
    .hidden { display: none; }
    .edit-controls { display: none; margin-left: 10px; }
    .edit-mode .edit-controls { display: flex; gap: 5px; }
    .edit-btn { background-color: #c8e6c9; color: #2e7d32; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .delete-btn { background-color: #fed7d7; color: #c53030; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .edit-btn:hover, .delete-btn:hover { transform: scale(1.1); }
    .initial-setup { text-align: center; padding: 2rem; }
    .link-container { text-align: center; margin-top: 1.5rem; }
    .link-container a { color: #8c2a32; text-decoration: none; font-weight: bold; }
    .link-container a:hover { text-decoration: underline; }
    .result-link { display: block; margin-top: 0.5rem; font-size: 1rem; }
  </style>
</head>
<body class="">
  <div class="header-container">
    <h1>ğŸ¥¢ ìœ¤ì´ ë­ë­ ë¨¹ì§€?</h1>
  </div>
  
  <div class="tree" id="tree">
    <p style="padding: 1rem; color: #888;">ë©”ë‰´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

  <div class="link-container">
      <a href="wine.html" target="_blank">ìœ ë‹ˆí˜€ë‹ˆ ì™€ì¸ ì•¨ë²” ê´€ë¦¬í•˜ê¸° â†—</a>
  </div>

  <div class="button-container hidden" id="button-container">
      <button class="action-button edit" id="edit-button">âœï¸ í¸ì§‘</button>
      <button class="action-button start" id="start-selection-button">âœ¨ ë©”ë‰´ ê²°ì • ì‹œì‘!</button>
      <button class="action-button reset" id="reset-button">ğŸ”„ ì´ˆê¸°í™”</button>
      <button class="action-button search hidden" id="kakaomap-button">ğŸ“ ë‚´ ì£¼ë³€ ë§›ì§‘ ê²€ìƒ‰</button>
  </div>
  <div class="result" id="result"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, addDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC93injuuKFQbJPkX-qxf2KRXW4g_AhUFM",
    authDomain: "wineproject-ad606.firebaseapp.com",
    projectId: "wineproject-ad606",
    storageBucket: "wineproject-ad606.appspot.com",
    messagingSenderId: "27425674688",
    appId: "1:27425674688:web:48c83136045b6f2aa96425"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const menuItemsCollection = collection(db, "menuItems");

  const body = document.body;
  const treeContainer = document.getElementById('tree');
  const editButton = document.getElementById('edit-button');
  const startButton = document.getElementById('start-selection-button');
  const resetButton = document.getElementById('reset-button');
  const kakaoMapButton = document.getElementById('kakaomap-button');
  const buttonContainer = document.getElementById('button-container');
  const resultDiv = document.getElementById('result');
  
  let selectionStartNodeName = null; // [ìˆ˜ì •] DOM ë…¸ë“œ ëŒ€ì‹  ì´ë¦„ìœ¼ë¡œ ìƒíƒœ ì €ì¥
  let isEditMode = false;
  let allMenuItems = [];

  onSnapshot(query(menuItemsCollection), (snapshot) => {
    allMenuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    if (allMenuItems.length === 0 && !document.querySelector('.initial-setup')) {
        renderInitialSetup();
    } else if (allMenuItems.length > 0) {
        renderTree(allMenuItems);
    }
  });

  function renderInitialSetup() {
    treeContainer.innerHTML = `
        <div class="initial-setup">
            <h3>ğŸ˜® ë©”ë‰´ê°€ í•˜ë‚˜ë„ ì—†ë„¤ìš”!</h3>
            <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ë³¸ ë©”ë‰´ë¥¼ ìƒì„±í•˜ê³  ì‹œì‘í•´ ë³´ì„¸ìš”.</p>
            <button id="create-default-menus-btn" class="action-button start">ê¸°ë³¸ ë©”ë‰´ ìƒì„±í•˜ê¸°</button>
        </div>
    `;
    document.getElementById('create-default-menus-btn').addEventListener('click', async (e) => {
        e.target.disabled = true;
        e.target.textContent = 'ìƒì„± ì¤‘...';
        await createDefaultMenus();
    });
  }

  async function createDefaultMenus() {
    const defaultMenus = [
        { name: 'ìˆ ì„ ë¨¹ëŠ”ë‹¤', parent: 'root' }, { name: 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤', parent: 'root' },
        { name: 'ì†Œì£¼', parent: 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' }, { name: 'ì‚¼ê²¹ì‚´', parent: 'ì†Œì£¼' }, { name: 'ê°ìíƒ•', parent: 'ì†Œì£¼' },
        { name: 'ë§¥ì£¼', parent: 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' }, { name: 'ì¹˜í‚¨', parent: 'ë§¥ì£¼' }, { name: 'í”¼ì', parent: 'ë§¥ì£¼' },
        { name: 'ì™€ì¸', parent: 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' }, { name: 'ìŠ¤í…Œì´í¬', parent: 'ì™€ì¸' }, { name: 'íŒŒìŠ¤íƒ€', parent: 'ì™€ì¸' }, { name: 'ì¹˜ì¦ˆ', parent: 'ì™€ì¸' },
        { name: 'ë§‰ê±¸ë¦¬', parent: 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' }, { name: 'íŒŒì „', parent: 'ë§‰ê±¸ë¦¬' },
        { name: 'í•œì‹', parent: 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤' }, { name: 'ì œìœ¡ë³¶ìŒ', parent: 'í•œì‹' }, { name: 'ê¹€ì¹˜ì°Œê°œ', parent: 'í•œì‹' },
        { name: 'ì–‘ì‹', parent: 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤' }, { name: 'íŒŒìŠ¤íƒ€', parent: 'ì–‘ì‹' }
    ];
    const batch = writeBatch(db);
    defaultMenus.forEach(menu => batch.set(doc(menuItemsCollection), menu));
    await batch.commit();
  }

  function renderTree(items) {
      treeContainer.innerHTML = '';
      const itemsByParent = items.reduce((acc, item) => {
          (acc[item.parent] = acc[item.parent] || []).push(item);
          return acc;
      }, {});
      const rootItems = itemsByParent['root'] || [];
      rootItems.forEach(item => {
          const nodeWrapper = createNodeElement(item, itemsByParent);
          treeContainer.appendChild(nodeWrapper);
      });

      // [ìˆ˜ì •] í¸ì§‘ í›„ì—ë„ ì„ íƒ ìƒíƒœ ë³µì›
      if (selectionStartNodeName) {
        const selectedNode = treeContainer.querySelector(`.node[data-name="${selectionStartNodeName}"]`);
        const otherNodeName = selectionStartNodeName === 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' ? 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤' : 'ìˆ ì„ ë¨¹ëŠ”ë‹¤';
        const otherNode = treeContainer.querySelector(`.node[data-name="${otherNodeName}"]`);
        if (selectedNode && otherNode) {
            makeChoice(selectedNode, otherNode);
        }
      }
  }
  
  function createNodeElement(item, itemsByParent) {
    const nodeWrapper = document.createElement('div');
    const node = document.createElement('div');
    node.className = 'node';
    node.dataset.id = item.id;
    node.dataset.name = item.name;

    const nodeContent = document.createElement('div');
    nodeContent.className = 'node-content';
    const nodeText = document.createElement('span');
    nodeText.className = 'node-text';
    nodeText.innerHTML = item.parent === 'root' ? `<strong>${item.name}</strong>` : item.name;
    nodeContent.appendChild(nodeText);
    node.appendChild(nodeContent);

    const children = itemsByParent[item.name] || [];
    const isParentNode = children.length > 0;
    
    // [ìˆ˜ì •] í¸ì§‘ ì»¨íŠ¸ë¡¤ UI ìƒì„± ë¡œì§ ë‹¨ìˆœí™”
    const editControls = document.createElement('div');
    editControls.className = 'edit-controls';
    if (isParentNode) {
        const addButton = document.createElement('button');
        addButton.className = 'edit-btn';
        addButton.textContent = '+';
        addButton.title = 'í•˜ìœ„ ë©”ë‰´ ì¶”ê°€';
        editControls.appendChild(addButton);
    }
    const deleteButton = document.createElement('button');
    deleteButton.className = 'delete-btn';
    deleteButton.textContent = 'Ã—';
    deleteButton.title = 'ì´ë²ˆ ì¶”ì²œì—ì„œ ì œì™¸í•˜ê¸°';
    if (item.parent !== 'root') {
      editControls.appendChild(deleteButton);
    }
    node.appendChild(editControls);
    nodeWrapper.appendChild(node);

    if (isParentNode) {
        node.classList.add('parent-node');
        const toggleIcon = document.createElement('span');
        toggleIcon.className = 'toggle-icon';
        toggleIcon.textContent = 'â–¶';
        nodeContent.insertBefore(toggleIcon, nodeText);
        const branch = document.createElement('div');
        branch.className = 'branch';
        children.forEach(child => {
            branch.appendChild(createNodeElement(child, itemsByParent));
        });
        nodeWrapper.appendChild(branch);
    }
    addNodeEventListeners(nodeWrapper);
    return nodeWrapper;
  }

  function addNodeEventListeners(nodeWrapper) {
      const node = nodeWrapper.querySelector('.node');
      const nodeContent = node.querySelector('.node-content');
      const parentName = node.dataset.name;

      if(node.classList.contains('parent-node')){
        nodeContent.addEventListener('click', () => {
            if(!isEditMode) toggleNode(node);
        });
      }
      
      if (parentName === 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' || parentName === 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤') {
          node.classList.add('choice-node');
          node.addEventListener('click', () => {
              if (isEditMode) return;
              const otherChoiceName = parentName === 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' ? 'ìˆ  ì•ˆ ë¨¹ëŠ”ë‹¤' : 'ìˆ ì„ ë¨¹ëŠ”ë‹¤';
              const otherNode = treeContainer.querySelector(`.node[data-name="${otherChoiceName}"]`);
              makeChoice(node, otherNode);
          });
      }

      const addBtn = node.querySelector('.edit-btn');
      if (addBtn) {
          addBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const newMenuNamesString = prompt(`'${parentName}'ì˜ í•˜ìœ„ ë©”ë‰´ë¥¼ ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.`);
              if (newMenuNamesString) {
                  const menuNames = newMenuNamesString.split(',').map(s => s.trim()).filter(Boolean);
                  const batch = writeBatch(db);
                  menuNames.forEach(name => {
                      batch.set(doc(menuItemsCollection), { name, parent: parentName });
                  });
                  batch.commit();
              }
          });
      }
      
      const deleteBtn = node.querySelector('.delete-btn');
      if (deleteBtn) {
          // [ìˆ˜ì •] ì‚­ì œ ë²„íŠ¼ ë¡œì§ ë³€ê²½
          deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              node.classList.toggle('temp-removed');
              deleteBtn.innerHTML = node.classList.contains('temp-removed') ? '&#43;' : '&times;';
              deleteBtn.title = node.classList.contains('temp-removed') ? 'ì¶”ì²œì— ë‹¤ì‹œ í¬í•¨í•˜ê¸°' : 'ì´ë²ˆ ì¶”ì²œì—ì„œ ì œì™¸í•˜ê¸°';
          });
      }
  }
  
  function toggleNode(node, forceExpand) {
      const branch = node.parentElement.querySelector('.branch');
      if (!branch) return;
      const isExpanded = node.classList.contains('expanded');
      const shouldBeVisible = forceExpand === undefined ? !isExpanded : forceExpand;
      node.classList.toggle('expanded', shouldBeVisible);
      branch.classList.toggle('visible', shouldBeVisible);
      const icon = node.querySelector('.toggle-icon');
      if(icon) {
          icon.style.transform = shouldBeVisible ? 'rotate(90deg)' : 'rotate(0deg)';
      }
  }
  
  function makeChoice(selectedNode, unselectedNode) {
    selectedNode.classList.add('selected');
    unselectedNode.classList.add('unselected');
    document.querySelectorAll('.choice-node').forEach(n => n.style.pointerEvents = 'none');
    toggleNode(selectedNode, true); 
    selectionStartNodeName = selectedNode.dataset.name; // ì´ë¦„ìœ¼ë¡œ ì €ì¥
    buttonContainer.classList.remove('hidden');
    const choiceText = selectedNode.dataset.name === 'ìˆ ì„ ë¨¹ëŠ”ë‹¤' ? 'ìˆ ê³¼ ì•ˆì£¼' : 'ë©”ë‰´';
    startButton.textContent = `âœ¨ ì˜¤ëŠ˜ì˜ ${choiceText} ê²°ì •!`;
  }
  
  editButton.addEventListener('click', () => {
      isEditMode = !isEditMode;
      body.classList.toggle('edit-mode');
      editButton.innerHTML = isEditMode ? 'âœ… ì™„ë£Œ' : 'âœï¸ í¸ì§‘';
  });

  resetButton.addEventListener('click', () => resetUIState(true));
  startButton.addEventListener('click', () => {
    const startNode = treeContainer.querySelector(`.node[data-name="${selectionStartNodeName}"]`);
    if (!startNode) return;
    buttonContainer.classList.add('hidden');
    simulateStepByStep(startNode);
  });
  
  function simulateStepByStep(startNode) {
    let current = startNode;
    const path = [current];
    while (true) {
        let branch = current.parentElement.querySelector('.branch');
        if (!branch) break;
        
        // [ìˆ˜ì •] ì œì™¸ í•„í„°ë§ ë¡œì§ ë³€ê²½
        let availableChildren = Array.from(branch.querySelectorAll(':scope > div > .node')).filter(c => !c.classList.contains('temp-removed'));
        
        if (availableChildren.length === 0) {
            resultDiv.textContent = `ğŸ¤” '${current.dataset.name}' ì¹´í…Œê³ ë¦¬ ë©”ë‰´ê°€ ëª¨ë‘ ì œì™¸ë˜ì—ˆì–´ìš”!`;
            buttonContainer.classList.remove('hidden');
            return;
        }
        const next = availableChildren[Math.floor(Math.random() * availableChildren.length)];
        path.push(next);
        current = next;
    }
    
    path.forEach(ensurePathVisible);
    let idx = 0;
    const interval = setInterval(() => {
        if (idx > 0 && path[idx - 1] !== startNode) path[idx - 1].classList.remove('highlight');
        if (idx < path.length) {
            path[idx].classList.add('highlight');
            idx++;
        } else {
            clearInterval(interval);
            const finalChoice = path[path.length - 1];
            const finalText = finalChoice.querySelector('.node-text').textContent.trim();
            finalChoice.classList.add('highlight');
            
            let resultHTML = `ğŸ‰ ì˜¤ëŠ˜ì€... <strong>${finalText}</strong>!`;

            if (isWineRelated(finalChoice.dataset.name, allMenuItems)) {
                resultHTML += `<a href="wine.html" class="result-link" target="_blank">ìœ ë‹ˆí˜€ë‹ˆ ì™€ì¸ ì•¨ë²”ì—ì„œ ì–´ìš¸ë¦¬ëŠ” ì™€ì¸ ì°¾ì•„ë³´ê¸° ğŸ·</a>`;
            }

            resultDiv.innerHTML = resultHTML;
            kakaoMapButton.dataset.food = finalText;
            buttonContainer.classList.remove('hidden');
            kakaoMapButton.classList.remove('hidden');
        }
    }, 700);
  }

  function isWineRelated(itemName, allItems) {
      let current = allItems.find(item => item.name === itemName);
      while(current) {
          if (current.name === 'ì™€ì¸') return true;
          current = allItems.find(item => item.name === current.parent);
      }
      return false;
  }

  function ensurePathVisible(node) {
    let current = node.parentElement.closest('.branch');
    while (current) {
        const parentNode = current.previousElementSibling;
        if (parentNode && parentNode.classList.contains('node') && !parentNode.classList.contains('expanded')) {
            toggleNode(parentNode, true);
        }
        current = current.parentElement.closest('.branch');
    }
  }

  function resetUIState(fullReset) {
    document.querySelectorAll('.highlight, .selected, .unselected, .temp-removed').forEach(n => n.classList.remove('highlight', 'selected', 'unselected', 'temp-removed'));
    document.querySelectorAll('.choice-node').forEach(n => n.style.pointerEvents = 'auto');
    document.querySelectorAll('.delete-btn').forEach(btn => { btn.innerHTML = '&times;'; });
    resultDiv.innerHTML = '';
    buttonContainer.classList.add('hidden');
    kakaoMapButton.classList.add('hidden');
    selectionStartNodeName = null;
    if(fullReset) {
        document.querySelectorAll('.branch.visible').forEach(b => b.classList.remove('visible'));
        document.querySelectorAll('.node.expanded').forEach(n => n.classList.remove('expanded'));
    }
  }

  kakaoMapButton.addEventListener('click', () => {
    const foodName = kakaoMapButton.dataset.food;
    if (!foodName) return;
    resultDiv.innerHTML = 'ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘... <div class="loading-spinner"></div>';
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const query = encodeURIComponent(foodName.split(' ')[0]);
        const url = `https://map.kakao.com/link/search/${query}`;
        window.open(url, '_blank');
        resultDiv.textContent = `âœ… '${foodName}' ì£¼ë³€ ë§›ì§‘ì„ ì¹´ì¹´ì˜¤ë§µì—ì„œ í™•ì¸í•˜ì„¸ìš”!`;
      },
      () => {
        resultDiv.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´, ê¸°ë³¸ ê²€ìƒ‰ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.';
        const query = encodeURIComponent(foodName.split(' ')[0]);
        const url = `https://map.kakao.com/link/search/${query}`;
        window.open(url, '_blank');
      }
    );
  });
</script>
</body>
</html>
